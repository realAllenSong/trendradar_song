name: Get Hot News

on:
  schedule:
    # Change only the first number (minute) to adjust run time.
    # Examples:
    #   "15 * * * *"    -> at minute 15 each hour
    #   "30 0-14 * * *" -> at minute 30, hours 0-14
    - cron: "33 */12 * * *"

  workflow_dispatch:

concurrency:
  group: crawler-${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write
  actions: write

jobs:
  assets:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Restore VoxCPM models cache
        id: cache-voxcpm
        uses: actions/cache/restore@v4
        with:
          path: models/ONNX_Lab/models
          key: voxcpm-models-${{ runner.os }}-${{ hashFiles('tools/ensure_voxcpm_assets.py') }}
          restore-keys: |
            voxcpm-models-${{ runner.os }}-

      - name: Restore Hugging Face cache
        id: cache-hf
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/huggingface
          key: hf-cache-${{ runner.os }}-${{ hashFiles('tools/ensure_voxcpm_assets.py', 'requirements.txt') }}
          restore-keys: |
            hf-cache-${{ runner.os }}-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests huggingface_hub tqdm

      - name: Ensure VoxCPM assets
        env:
          CONFIG_PATH: config/config.yaml
          VOXCPM_ONNX_REPO: Oulasong/voxcpm-onnx
          VOXCPM_MODEL_REPO: openbmb/VoxCPM1.5
        run: |
          python tools/ensure_voxcpm_assets.py

      - name: Save VoxCPM models cache
        if: steps.cache-voxcpm.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: models/ONNX_Lab/models
          key: voxcpm-models-${{ runner.os }}-${{ hashFiles('tools/ensure_voxcpm_assets.py') }}

      - name: Save Hugging Face cache
        if: steps.cache-hf.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/huggingface
          key: hf-cache-${{ runner.os }}-${{ hashFiles('tools/ensure_voxcpm_assets.py', 'requirements.txt') }}

  crawl:
    runs-on: ubuntu-latest
    needs: [assets]
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Restore VoxCPM models cache
        uses: actions/cache/restore@v4
        with:
          path: models/ONNX_Lab/models
          key: voxcpm-models-${{ runner.os }}-${{ hashFiles('tools/ensure_voxcpm_assets.py') }}
          restore-keys: |
            voxcpm-models-${{ runner.os }}-

      - name: Restore Hugging Face cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/huggingface
          key: hf-cache-${{ runner.os }}-${{ hashFiles('tools/ensure_voxcpm_assets.py', 'requirements.txt') }}
          restore-keys: |
            hf-cache-${{ runner.os }}-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install torch (CPU)
        run: |
          python -m pip install -U pip setuptools wheel
          pip install --extra-index-url https://download.pytorch.org/whl/cpu torch==2.2.2

      - name: Install requirements (verbose)
        run: |
          pip install -r requirements.txt -v

      - name: Verify required files
        run: |
          if [ ! -f config/config.yaml ]; then
            echo "Error: Config missing"
            exit 1
          fi

      - name: Run crawler
        env:
          AUDIO_ENABLED: "false"
          TREND_RADAR_EXPORT_REPORT_PATH: output/report.json
          TREND_RADAR_EXPORT_CRAWL_PATH: output/crawl.json
          TREND_RADAR_HEARTBEAT_SECONDS: "60"
          CRAWLER_CONNECT_TIMEOUT_SECONDS: "20"
          CRAWLER_READ_TIMEOUT_SECONDS: "60"
          CRAWLER_MAX_RETRIES: "4"
          CRAWLER_RETRY_MIN_SECONDS: "5"
          CRAWLER_RETRY_MAX_SECONDS: "15"
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
          WEWORK_MSG_TYPE: ${{ secrets.WEWORK_MSG_TYPE }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          NTFY_SERVER_URL: ${{ secrets.NTFY_SERVER_URL }}
          NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}
          BARK_URL: ${{ secrets.BARK_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          STORAGE_BACKEND: auto
          LOCAL_RETENTION_DAYS: ${{ secrets.LOCAL_RETENTION_DAYS }}
          REMOTE_RETENTION_DAYS: ${{ secrets.REMOTE_RETENTION_DAYS }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_ENDPOINT_URL: ${{ secrets.S3_ENDPOINT_URL }}
          S3_REGION: ${{ secrets.S3_REGION }}
          GITHUB_ACTIONS: true
        run: python -m trendradar

      - name: Upload crawl artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crawl-output
          path: |
            output/report.json
            output/crawl.json
          retention-days: 1
          if-no-files-found: warn

      - name: Commit index.html
        if: success()
        run: |
          if [ ! -f index.html ]; then
            echo "index.html not found, skipping commit"
            exit 0
          fi

          git add index.html

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update report"
          git push

  audio:
    runs-on: ubuntu-latest
    needs: [assets, crawl]
    timeout-minutes: 120  # Extended timeout to handle slow runners
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Restore VoxCPM models cache
        uses: actions/cache/restore@v4
        with:
          path: models/ONNX_Lab/models
          key: voxcpm-models-${{ runner.os }}-${{ hashFiles('tools/ensure_voxcpm_assets.py') }}
          restore-keys: |
            voxcpm-models-${{ runner.os }}-

      - name: Restore Hugging Face cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/huggingface
          key: hf-cache-${{ runner.os }}-${{ hashFiles('tools/ensure_voxcpm_assets.py', 'requirements.txt') }}
          restore-keys: |
            hf-cache-${{ runner.os }}-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost || true
          sudo apt-get clean
          echo "After cleanup:"
          df -h

      - name: System dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ffmpeg espeak-ng libsndfile1 \
            build-essential python3-dev pkg-config \
            libffi-dev libssl-dev \
            libasound2-dev portaudio19-dev
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Debug disk/memory
        run: |
          df -h
          du -sh models/ONNX_Lab/models || true
          du -sh ~/.cache/pip || true
          free -h

      - name: Install torch (CPU)
        run: |
          python -m pip install -U pip setuptools wheel
          pip install --extra-index-url https://download.pytorch.org/whl/cpu torch==2.2.2

      - name: Install requirements (verbose)
        run: |
          pip install -r requirements.txt -v

      - name: Ensure VoxCPM assets
        env:
          CONFIG_PATH: config/config.yaml
          VOXCPM_ONNX_REPO: Oulasong/voxcpm-onnx
          VOXCPM_MODEL_REPO: openbmb/VoxCPM1.5
        run: |
          python tools/ensure_voxcpm_assets.py

      - name: Download crawl artifacts
        uses: actions/download-artifact@v4
        with:
          name: crawl-output
          path: output

      - name: Verify report artifact
        run: |
          if [ ! -f output/report.json ]; then
            echo "report.json not found, abort"
            exit 1
          fi

      - name: Run audio generation
        env:
          AUDIO_ENABLED: "true"
          AUDIO_INTERVAL_HOURS: "0"
          TREND_RADAR_AUDIO_REPORT_PATH: output/report.json
          TREND_RADAR_HEARTBEAT_SECONDS: "60"
          AUDIO_FETCH_TIMEOUT_SECONDS: "45"
          AUDIO_FETCH_MAX_RETRIES: "3"
          AUDIO_FETCH_RETRY_BACKOFF_SECONDS: "1.5"
          AUDIO_GEMINI_MAX_RETRIES: "3"
          AUDIO_GEMINI_BACKOFF_SECONDS: "2"
          AUDIO_GEMINI_MAX_BACKOFF_SECONDS: "12"
          AUDIO_TTS_TIMEOUT_SECONDS: "120"
          AUDIO_TTS_EVENT_TIMEOUT_SECONDS: "240"
          AUDIO_TTS_MAX_RETRIES: "3"
          AUDIO_TTS_RETRY_BACKOFF_SECONDS: "2"
          AUDIO_MAX_SEGMENTS: "10"
          VOXCPM_BATCH_SIZE: "2"
          VOXCPM_MAX_THREADS: "0"
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          INDEXTTS_ENDPOINT: ${{ secrets.INDEXTTS_ENDPOINT }}
          INDEXTTS_API_KEY: ${{ secrets.INDEXTTS_API_KEY }}
          GITHUB_ACTIONS: true
        run: python -m trendradar

      - name: Commit audio outputs
        if: success()
        run: |
          if [ ! -f audio/latest.mp3 ]; then
            echo "audio/latest.mp3 not found, skipping commit"
            exit 1
          fi

          # Stash any unstaged changes BEFORE adding audio files
          if ! git diff --quiet || ! git diff --cached --quiet; then
            echo "Stashing uncommitted changes"
            git stash --include-untracked
          fi

          git add audio/latest.mp3 audio/chapters.json audio/transcript.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update audio"
          git pull --rebase origin master
          git push
